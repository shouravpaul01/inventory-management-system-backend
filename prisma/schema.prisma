generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                 String            @id @default(auto()) @map("_id") @db.ObjectId
  name               String
  email              String            @unique
  phone              String            @unique
  photo              String?
  role               UserRole
  roleBasedAccess    RoleBasedAccess[] @default([])
  status             UserStatus        @default(ACTIVE)
  needChangePassword Boolean           @default(true)
  isDeleted          Boolean           @default(false)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  credential     UserCredential?
  allocatedItems AllocatedItem[]
  orders         Order[]
  actionLogs     ActionLog[]
  notifications  Notification[]

  @@map("users")
}

model UserCredential {
  id     String @id @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  password    String
  otp         String?
  otpExpireAt DateTime?

  @@map("user_credentials")
}

model Room {
  id             String         @id @map("_id") @db.ObjectId
  floor          String
  roomNo         Int            @unique
  type           String
  images         String[]       @default([])
  description    String?
  specifications String?
  status         Status         @default(ACTIVE)
  approvalStatus ApprovalStatus @default(PENDING)

  stocks          Stock[]
  stores          Store[]
  allocatedItems  AllocatedItem[]
  deliveryDetails DeliveryDetails[]

  @@map("rooms")
}

model Category {
  id             String         @id @map("_id") @db.ObjectId
  name           String         @unique
  status         Status         @default(ACTIVE)
  approvalStatus ApprovalStatus @default(PENDING)

  subCategories  SubCategory[]
  inventoryItems InventoryItem[]

  @@map("categories")
}

model SubCategory {
  id             String         @id @map("_id") @db.ObjectId
  name           String         @unique
  status         Status         @default(ACTIVE)
  approvalStatus ApprovalStatus @default(PENDING)

  categoryId     String          @db.ObjectId
  category       Category        @relation(fields: [categoryId], references: [id])
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  inventoryItems InventoryItem[]

  @@map("sub_categories")
}

model CodeSequence {
  id             String         @id @map("_id") @db.ObjectId
  prefix         String         @unique
  nextNumber     Int?
  approvalStatus ApprovalStatus @default(PENDING)

  inventoryItem InventoryItem?

  @@map("code_sequences")
}

model InventoryItem {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  baseCodeId     String       @unique @db.ObjectId
  baseCode       CodeSequence @relation(fields: [baseCodeId], references: [id])
  name           String       @unique
  description    String?
  specifications String?
  categoryId     String       @db.ObjectId
  subCategoryId  String       @db.ObjectId
  category       Category     @relation(fields: [categoryId], references: [id])
  subCategory    SubCategory  @relation(fields: [subCategoryId], references: [id])

  // Stock Management
  totalQuantity Int @default(0)

  availableQuantity   Int @default(0)
  distributedQuantity Int @default(0)

  totalCodes       String[] @default([])
  availableCodes   String[] @default([])
  distributedCodes String[] @default([])

  status         Status         @default(ACTIVE)
  approvalStatus ApprovalStatus @default(PENDING)
  type           ItemType

  stocks Stock[]
  stores Store[]

  @@map("inventory_items")
}

model Stock {
  id              String        @id @map("_id") @db.ObjectId
  inventoryItemId String        @db.ObjectId
  inventortyItem  InventoryItem @relation(fields: [inventoryItemId], references: [id])
  quantity        Int
  codes           String[]      @default([])
  description     String?
  specifications  String?
  images          String[]      @default([])

  status         Status         @default(ACTIVE)
  approvalStatus ApprovalStatus @default(PENDING)

  room   Room?   @relation(fields: [roomId], references: [id])
  roomId String? @db.ObjectId

  @@map("stocks")
}

model Store {
  id                  String        @id @map("_id") @db.ObjectId
  inventoryItemId     String        @db.ObjectId
  inventortyItem      InventoryItem @relation(fields: [inventoryItemId], references: [id])
  quantity            Int
  codes               String[]      @default([])
  roomId              String?       @db.ObjectId
  room                Room?         @relation(fields: [roomId], references: [id])
  otherStoredLocation String?
  images              String[]      @default([])
  description         String?

  @@map("stores")
}

model Order {
  id               String    @id @map("_id") @db.ObjectId
  userId           String    @db.ObjectId
  user             User      @relation(fields: [userId], references: [id])
  expectedDateTime DateTime
  returnDeadline   DateTime?

  status          OrderAndAllocatedItemsStatus @default(PENDING)
  items           Item[]
  deliveryDetails DeliveryDetails?

  @@map("orders")
}

model DeliveryDetails {
  id            String  @id @map("_id") @db.ObjectId
  roomId        String? @db.ObjectId
  room          Room?   @relation(fields: [roomId], references: [id])
  orderLocation String?
  orderId       String  @unique @db.ObjectId
  order         Order   @relation(fields: [orderId], references: [id])

  @@map("delivery_details")
}

model AllocatedItem {
  id                  String             @id @map("_id") @db.ObjectId
  type                AllocatedItemsType @default(REQUESTED)
  userId              String             @db.ObjectId
  user                User               @relation(fields: [userId], references: [id])
  roomId              String?            @db.ObjectId
  room                Room?              @relation(fields: [roomId], references: [id])
  otherStoredLocation String?
  descriptions        String?

  status OrderAndAllocatedItemsStatus @default(PENDING)
  items  Item[]

  @@map("allocated_items")
}

model Item {
  id              String         @id @map("_id") @db.ObjectId
  quantity        Int
  providedCodes   String[]       @default([])
  allocatedItemId String?        @db.ObjectId
  allocatedItem   AllocatedItem? @relation(fields: [allocatedItemId], references: [id])
  orderId         String?        @db.ObjectId
  order           Order?         @relation(fields: [orderId], references: [id])

  @@map("items")
}

model ActionLog {
  id String @id @map("_id") @db.ObjectId

  // Who did the action
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // On which entity
  entityType EntityType
  entityId   String     @db.ObjectId

  // What action
  action ActionType
  status ActionStatus?

  // Optional context
  description String?
  meta        Json?

  createdAt DateTime @default(now())

  @@map("action_logs")
}

model Notification {
  id String @id @map("_id") @db.ObjectId

  // Receiver
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  title   String
  message String

  entityType EntityType?
  entityId   String?     @db.ObjectId

  type   NotificationType
  isRead Boolean          @default(false)

  createdAt DateTime @default(now())

  @@map("notifications")
}

// -----Enum------ //
enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum RoleBasedAccess {
  ALL
}

enum Status {
  ACTIVE
  INACTIVE
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ItemType {
  RETURNABLE
  NONRETURNABLE
  GIFT
}

enum OrderAndAllocatedItemsStatus {
  PENDING
  APPROVED
  DELIVERD
  RECEIVED
  RETURNED
  RETURNED_RECEIVED
}

enum AllocatedItemsType {
  REQUESTED
  PROVIDED
}

enum EntityType {
  USER
  INVENTORY_ITEM
  STOCK
  STORE
  ORDER
  ALLOCATED_ITEM
  DELIVERY_DETAILS
  ROOM
}

enum ActionType {
  CREATE
  UPDATE
  DELETE
  REQUESTED
  APPROVED
  REJECTED
  ALLOCATE
  ISSUE
  DELIVERED
  RECEIVED
  RETURNED
  RETURNED_RECEIVED
}

enum ActionStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum NotificationType {
  INFO
  ACTION
  WARNING
  SUCCESS
}
