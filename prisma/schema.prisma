generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  email       String  @unique
  phone       String  @unique
  photo       String?
  designation String?
  department  String  @default("Computer Science and Engineering")

  role               UserRole
  permissions        RoleBasedAccess[] @default([])
  status             UserStatus        @default(ACTIVE)
  needChangePassword Boolean           @default(true)
  isDeleted          Boolean           @default(false)
  isEmailVerified    Boolean           @default(true)

  credential       UserCredential?
  allocations      Allocation[]
  orders           Order[]
  actionLogs       ActionLog[]
  notifications    Notification[]
 

  @@index([role])
  @@index([status])
  @@map("users")
}

model UserCredential {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  password    String
  otp         String?
  otpExpireAt DateTime?
  refreshToken String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("user_credentials")
}

model Room {
  id             String         @id @default(auto()) @map("_id")  @db.ObjectId
  floor          String
  roomNo         Int            @unique
  type           String
  images         String[]       @default([])
  description    String?
  specifications String?
  status         Status         @default(ACTIVE)
  approvalStatus ApprovalStatus @default(PENDING)

  stocks        Stock[]
  storages      Storage[]
  allocations   Allocation[]
  deliveryInfos DeliveryInfo[]

  @@index([floor])
  @@index([status])
  @@map("rooms")
}

model Category {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  name           String         @unique
  description    String?
  status         Status         @default(ACTIVE)
  approvalStatus ApprovalStatus @default(PENDING)

  subCategories  SubCategory[]
  inventoryItems InventoryItem[]

  @@map("categories")
}

model SubCategory {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  name           String         @unique
  description    String?
  status         Status         @default(ACTIVE)
  approvalStatus ApprovalStatus @default(PENDING)

  categoryId     String          @db.ObjectId
  category       Category        @relation(fields: [categoryId], references: [id])
  inventoryItems InventoryItem[]

  @@index([categoryId])
  @@map("sub_categories")
}

model ItemCodeSequence {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  prefix         String         @unique
  nextNumber     Int?
  approvalStatus ApprovalStatus @default(PENDING)

  inventoryItem InventoryItem?

  @@map("item_code_sequences")
}

model InventoryItem {
  id         String           @id @default(auto()) @map("_id") @db.ObjectId
  baseCodeId String           @unique @db.ObjectId
  baseCode   ItemCodeSequence @relation(fields: [baseCodeId], references: [id])

  name           String  @unique
  description    String?
  specifications String?

  categoryId    String      @db.ObjectId
  subCategoryId String      @db.ObjectId
  category      Category    @relation(fields: [categoryId], references: [id])
  subCategory   SubCategory @relation(fields: [subCategoryId], references: [id])

  totalQuantity       Int @default(0)
  availableQuantity   Int @default(0)
  distributedQuantity Int @default(0)

  totalCodes       String[] @default([])
  availableCodes   String[] @default([])
  distributedCodes String[] @default([])

  type           ItemType
  status         Status         @default(ACTIVE)
  approvalStatus ApprovalStatus @default(PENDING)

  stocks   Stock[]
  storages Storage[]

  @@index([availableCodes])
  @@index([distributedCodes])
  @@index([totalCodes])
  @@index([categoryId])
  @@index([subCategoryId])
  @@map("inventory_items")
}

model Stock {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  inventoryItemId String        @db.ObjectId
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  quantity       Int
  codes          String[] @default([])
  description    String?
  specifications String?
  images         String[] @default([])

  roomId String? @db.ObjectId
  room   Room?   @relation(fields: [roomId], references: [id])

  status         Status         @default(ACTIVE)
  approvalStatus ApprovalStatus @default(PENDING)

  @@index([inventoryItemId])
  @@index([roomId])
  @@index([codes])
  @@map("stocks")
}

model Storage {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  inventoryItemId String        @db.ObjectId
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  quantity      Int
  codes         String[] @default([])
  roomId        String?  @db.ObjectId
  room          Room?    @relation(fields: [roomId], references: [id])
  otherLocation String?

  images      String[] @default([])
  description String?

  @@index([inventoryItemId])
  @@index([roomId])
  @@index([codes])
  @@map("storages")
}

model Order {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  expectedDateTime DateTime
  returnDeadline   DateTime?

  status       OrderAndAllocationStatus @default(PENDING)
  items        OrderItem[]
  deliveryInfo DeliveryInfo?

  @@map("orders")
}

model DeliveryInfo {
  id            String  @id @default(auto()) @map("_id") @db.ObjectId
  roomId        String? @db.ObjectId
  room          Room?   @relation(fields: [roomId], references: [id])
  orderLocation String?

  orderId String @unique @db.ObjectId
  order   Order  @relation(fields: [orderId], references: [id])

  @@map("delivery_infos")
}

model Allocation {
  id   String         @id @default(auto()) @map("_id") @db.ObjectId
  type AllocationType @default(REQUESTED)

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  roomId              String? @db.ObjectId
  room                Room?   @relation(fields: [roomId], references: [id])
  otherStoredLocation String?
  description         String?

  status OrderAndAllocationStatus @default(PENDING)
  items  OrderItem[]

  @@index([userId])
  @@index([status])
  @@map("allocations")
}

model OrderItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  quantity      Int
  providedCodes String[] @default([])

  allocationId String?
  allocation   Allocation? @relation(fields: [allocationId], references: [id])

  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id])

  @@map("order_items")
}

model ActionLog {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  entityType EntityType
  entityId   String     @db.ObjectId

  action ActionType
  status ActionStatus?

  description String?
  meta        Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@map("action_logs")
}

model Notification {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  title   String
  message String

  entityType EntityType?
  entityId   String?     @db.ObjectId

  type   NotificationType
  isRead Boolean          @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STAFF
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum RoleBasedAccess {
  ALL
}

enum Status {
  ACTIVE
  INACTIVE
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ItemType {
  RETURNABLE
  NONRETURNABLE
  GIFT
}

enum OrderAndAllocationStatus {
  PENDING
  APPROVED
  DELIVERED
  RECEIVED
  RETURNED
  RETURNED_RECEIVED
}

enum AllocationType {
  REQUESTED
  PROVIDED
}

enum EntityType {
  USER
  CATEGORY
  SUBCATEGORY
  INVENTORY_ITEM
  STOCK
  STORAGE
  ORDER
  ALLOCATION
  DELIVERY_INFO
  ROOM
}

enum ActionType {
  CREATE
  UPDATE
  DELETE
  REQUESTED
  APPROVED
  REJECTED
  ALLOCATE
  ISSUE
  DELIVERED
  RECEIVED
  RETURNED
  RETURNED_RECEIVED
  PASSWORD_CHANGED
}

enum ActionStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum NotificationType {
  INFO
  ACTION
  WARNING
  SUCCESS
}
